---
title: "Assignment 5 - DESeq2"
author: "Ryan Yordanoff"
output: html_document
---


For more detailed instructions, please read the assignment page in the course textbook. 


Use this block to source your `main.R`.

```{r setup, include=FALSE, results='hide'}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
source('main.R')
```


## 1. Reading and subsetting the data from verse_counts.tsv and sample_metadata.csv

To begin, we will subset the counts matrix to only contain a subset of samples
found in the original data. We have provided you with the *full* counts matrix
of samples and a metadata file containing relevant experimental variables for
each sample. These files are named 'verse_counts.tsv' and 'sample_metadata.csv',
respectively. Define a function that reads from these two files to construct a
counts matrix and matching sample dataframe containing only samples belonging to
the vP0 and vAd timepoints. This should correspond to a total of 4 samples
(vP0_1, vP0_2, vAd_1, 'vAd_2). Store this counts matrix and the sample dataframe
in a SummarizedExperiments object. Ensure that the name of your counts matrix
stored as an assay in the SummarizedExperiment object is `counts`.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
#Read in verse_counts.tsv and sample_metadata.csv and subset to the listed samples
#Store these dataframes in a SummarizedExperiment object and display the summary here

se <- make_se('verse_counts.tsv', 'sample_metadata.csv', c('vP0', 'vAd'))
se
```


Display the colData from your SummarizedExperiment object here:

```{r, echo=FALSE}
#Display the sample data from your SE object here to make sure the order is right 
colData(se)
```

## 2. [Running DESeq2](http://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#differential-expression-analysis)

DESeq2 has a built-in function that directly uses a SummarizedExperiment object.
Define a function that takes your SummarizedExperiment and a design formula and
runs DESeq2 with standard parameters. In our case, we wish to determine what
genes are differentially expressed between our samples based on timepoint and
our model will simply be `~ timepoint` and we will use `vP0` as our reference
level. 

Return a *list* containing both the results from DESeq2 as a dataframe as well
as the DESeqDataSet object updated with various statistics in the course of the 
analysis (referred to as the dds in the vignette)

```{r, run deseq2, echo=FALSE,  message=TRUE}
#Run your DESeq2 function here which returns a list of the dds and the results
#Assign the results and the dds from the returned list to their own variables 
#for ease of use
res <- return_deseq_res(se, ~ timepoint)

deseq_res <- res$res

deseq_dds <- res$dds

summary(res)
```

## 3. Annotating results to construct a labeled volcano plot

Using the results generated by DESeq2, convert it to a `tibble` and add one
additional column that denotes whether a gene is either: 1. Upregulated and
significant at a given padj threshold, 2.Downregulated and significant at a
given padj threshold, or 3. Not significant at a given padj threshold. __Name
this column `volc_plot_status`. Make sure the values for these labels are UP, DOWN,
and NS, respectively. __ Have your function take the DESeq2 results as well as a
user-defined threshold for padj and set it at .10.

```{r, label results tibble, echo=FALSE}
#Label the results with the column as specified above
#Display the summary of the tibble

labeled_results <- label_res(deseq_res, .10)

labeled_results

```

### Captions for figures

```{r code block for descriptive captions}

caption_4 <- 'Resulting p-value counts for all genes in differential expression analysis of in vivo mouse heart developement mRNAseq samples. Sample collection from postnatal day 0 and adult mouse heart.'
caption_5 <- 'Resulting positive and negative log2FoldChanges for differentially expressed mouse heart developement genes exceeding defined threshold of p value adjusted = 0.10 in differential expression analysis using DESeq2. Sample collection from postnatal day 0 and adult mouse heart.'
caption_6 <- 'Normalized differential expression counts of the ten most differentially expressed genes by p value adjusted.'
caption_7 <- 'Expression count change comparing postnatal day 0 and adult mouse heart gene expression. Genes meeting filter threshold are depicted with a relative increase, decrease or non-significant change in expression.'
caption_9 <- 'Normalized Enrichment Score (NES) of genes with the ten highest positive and negative NES scores from the C2 Canonical Pathways gene set collection.'

```

## 4. Diagnostic plot of the raw p-values for all genes

Using the same results tibble from the previous function, plot a histogram of
the raw p-values for all of the genes discovered in the experiment. Avoid using
the base ggplot2 theme and make sure to label any appropriate axes and
components of the plot.

```{r, raw pval histogram, echo=FALSE, warning=FALSE, fig.cap = caption_4}
plot_pvals(labeled_results)
```

## 5. Plotting the LogFoldChanges for differentially expressed genes

Using the results tibble, make a histogram of the Log2FoldChange values for all
significant differentially expressed genes at a user-defined padj threshold and
set this threshold to .10. Avoid using the base ggplot2 theme and make sure to
label any appropriate axes and components of the plot.

```{r, log2fc DE genes histogram, echo=FALSE, fig.cap = caption_5}
#Histogram of log2FC values for significant DE genes with padj (FDR) < .10
plot_log2fc(labeled_results, .10)

```

## 6. Plotting the normalized counts of differentially expressed genes

Extract out the DESeq2 normalized counts (by size factors) for the top ten
differentially expressed genes as ranked by ascending padj. Make a scatter / 
jitter plot of the counts and label each by their samplenames. 

```{r, plot of normalized counts, echo=FALSE, fig.cap = caption_6}
#Make a scatter/jitter plot of the norm counts for the top ten DE genes ranked
#by padj
scatter_norm_counts(labeled_results, deseq_dds, 10)
```


## 7. Volcano Plot to visualize differential expression results

Using the status column you generated in part 3, make a volcano plot of the
DESeq2 results and color the points appropriately. 

```{r, volcano plot, echo=FALSE, warning=FALSE, fig.cap = caption_7}
#Volcano Plot (scatter plot with log2FC on x-axis and -log10(padj) on y-axis)
#Color points (genes) by status defined in part 3
plot_volcano(labeled_results)
```

## 8. Running fgsea

Perform a GSEA using a ranked list log2FoldChange values for all genes
discovered in the DESeq2 results against the C2 Canonical Pathways gene set
collection. Remember to convert the gene identifiers in our results to the
appropriate matching format found in the C2 gene sets. fgsea expects a named
vector of gene level statistics and the gene sets in the form of a named list.
As recommended, please set the minSize and maxSize parameters to 15 and 500,
respectively. Otherwise, run fgsea using default parameters and the `fgsea()`
function.

```{r, run fgsea using log2fc, warning=FALSE, message=FALSE, echo=FALSE}
#Run fgsea using a ranked list of descending log2FC against the C2 canonical
#pathways gene set
#Set minsize to 15 and maxsize to 500, leave the other parameters as defaults
fgsea_result <- run_gsea(labeled_results, 'c2.cp.v7.5.1.symbols.gmt', 15, 500)

```


```{r, fgsea results, echo=FALSE}
#Display the results of the fgsea in a tibble sorted by padj (ascending)
fgsea_result %>% arrange(padj)
```


## 9. Plotting the top ten positive NES and top ten negative NES pathways

To make a quick visualization of these GSEA results, make a barchart for the
pathways with the top ten most positive and top ten most negative NES scores.
Color the bars by whether they have a positive or negative NES.

```{r, fgsea results plot, echo=FALSE, fig.cap = caption_9, dpi=350, fig.width=20, fig.height=12, fig.align='center'}
#Plot the top ten pathways with both positive and negative NES (20 total)
#Color the pathways by the sign of their NES (positive or negative)
top_pathways(fgsea_result, 10)
```

